import os, sys, subprocess, socket, json

# ==============================================================================
# ğŸ“¡ NETWORK UTILITIES
# ==============================================================================
def get_local_ip():
    """Automatically detects the local intranet IP address."""
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    try:
        # Does not actually connect, used to find the outgoing interface
        s.connect(('8.8.8.8', 1))
        ip = s.getsockname()[0]
    except Exception:
        ip = '127.0.0.1'
    finally:
        s.close()
    return ip

def run_cmd(cmd):
    """Executes pip install for required dependencies."""
    return subprocess.check_call([sys.executable, "-m", "pip", "install"] + cmd)

# ==============================================================================
# ğŸ› ï¸ MAIN FABRICATOR LOGIC
# ==============================================================================
def setup():
    local_ip = get_local_ip()
    print("\n" + "â•"*60)
    print(f" ğŸ­ HIVE FABRICATOR v1.5 // LOCAL IP: {local_ip}")
    print(" ğŸ›¡ï¸  INDUSTRIAL GRADE DEPLOYMENT TOOL (OPEN-SOURCE)")
    print("â•"*60)

    # 1. Dependency Injection
    print("\n [1/4] Checking dependencies (FastAPI, uvicorn, httpx, psutil)...")
    try:
        run_cmd(["fastapi", "uvicorn", "httpx", "psutil"])
        print(" [SUCCESS] All components ready.")
    except Exception as e:
        print(f" [ERROR] Installation failed: {e}"); return

    # 2. Intranet Configuration
    config_file = "hive_config.json"
    if os.path.exists(config_file):
        with open(config_file, "r") as f:
            config = json.load(f)
        print(f"\n [ğŸ”] Existing Config Found: Queen({config['queen_ip']}), Cell({config['cell_ip']})")
        if input("  > Keep these settings? (y/n): ").lower() != 'y':
            os.remove(config_file)
            return setup() 
    else:
        print("\n [ğŸŒ] Intranet Configuration (Press Enter for Default)")
        q_ip = input(f"  > Queen IP (Local: {local_ip}): ") or local_ip
        c_ip = input(f"  > Cell IP  (Local: {local_ip}): ") or local_ip
        config = {"queen_ip": q_ip, "cell_ip": c_ip}
        with open(config_file, "w") as f:
            json.dump(config, f)

    # 3. Role Assignment
    print("\n [2/4] Select the role for this computer:")
    print("  (1) Queen : Master control & Load balancing")
    print("  (2) Drone : AI Inference & Task execution (Worker)")
    print("  (3) Cell  : Log Archiving & Audit (Archivist)")
    
    choice = input("\n Choice (1-3): ").strip()

    # 4. Source Code Generation
    print("\n [3/4] Injecting HIVE DNA and generating files...")
    
    # --- Queen Code ---
    if choice == "1":
        with open("queen.py", "w", encoding="utf-8") as f:
            f.write(f"""# HIVE Queen Node v6.5 - Industrial Controller
import fastapi, httpx, os, time, threading, asyncio, uvicorn
from fastapi.responses import StreamingResponse

app = fastapi.FastAPI()
CONFIG = {json.dumps(config)}
# Worker Registry (Update manually or implement discovery)
WORKERS = [
    {{"id": "DRONE-01", "url": "http://127.0.0.1:8081", "status": "OFFLINE", "load": 0, "conn": 0}}
]

def draw_tui():
    while True:
        os.system("clear" if os.name != "nt" else "cls")
        print(" â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
        print(f" â”‚ ğŸ‘‘ HIVE QUEEN // MASTER CONSOLE (ECU)            â”‚")
        print(" â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
        for w in WORKERS:
            icon = "ğŸŸ¢" if w['status'] == "ONLINE" else "ğŸ”´"
            print(f" â”‚ {{icon}} {{w['id']:<10}} {{w['status']:<8}} LOAD: {{w['load']:>3}}%     â”‚")
        print(" â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
        time.sleep(1)

@app.post("/v1/chat/completions")
async def balance(req: fastapi.Request):
    # Load balancing logic to be implemented here
    return {{"msg": "Queen is operational"}}

if __name__ == "__main__":
    threading.Thread(target=draw_tui, daemon=True).start()
    uvicorn.run(app, host="0.0.0.0", port=8000, log_level="critical")
""")
        print(" [COMPLETE] queen.py generated.")

    # --- Drone Code ---
    elif choice == "2":
        with open("drone.py", "w", encoding="utf-8") as f:
            f.write(f"""# HIVE Drone Node v6.5 - AI Worker
import fastapi, httpx, psutil, uvicorn, sys

app = fastapi.FastAPI()
CONFIG = {json.dumps(config)}

@app.get("/health")
async def health():
    return {{"load": psutil.cpu_percent(), "conn": 0}}

@app.post("/v1/chat/completions")
async def infer():
    # LLM Inference logic to be implemented here
    return {{"msg": "Drone response"}}

if __name__ == "__main__":
    port = int(sys.argv[1]) if len(sys.argv) > 1 else 8081
    print(f" [âš”ï¸] Drone reporting to Queen at {{CONFIG['queen_ip']}}")
    uvicorn.run(app, host="0.0.0.0", port=port, log_level="critical")
""")
        print(f" [COMPLETE] drone.py generated. (Default Port: 8081)")

    # --- Cell Code ---
    elif choice == "3":
        with open("cell.py", "w", encoding="utf-8") as f:
            f.write(f"""# HIVE Cell Node v6.5 - Log Archivist
import fastapi, uvicorn, datetime

app = fastapi.FastAPI()

@app.post("/write")
async def write(req: fastapi.Request):
    data = await req.json()
    timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    log = f"[{{timestamp}}] [{{data.get('source')}}] {{data.get('message')}}\\n"
    with open("hive_archive.log", "a") as f: f.write(log)
    print(log, end="")
    return {{"status": "recorded"}}

if __name__ == "__main__":
    print("ğŸ›ï¸ HIVE ARCHIVIST (CELL) ONLINE")
    uvicorn.run(app, host="0.0.0.0", port=9000)
""")
        print(" [COMPLETE] cell.py generated.")

    print("\n" + "â•"*60)
    print(" ğŸ‰ HIVE Node Setup Complete! All systems GO.")
    print("â•"*60)

if __name__ == "__main__":
    setup()
